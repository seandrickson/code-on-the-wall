<!DOCTYPE html>
<script>
    'use strict';

    // https://api.cdnjs.com/libraries?search=lodash&output=human
    var GOOGLE_FONT_URL_PATTERN = 'https://fonts.googleapis.com/css?family={0}';
    var GOOGLE_FONT_DEFAULT = 'Source Code Pro';
    var HIGHLIGHT_CSS_URL_PATTERN = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/{0}.min.css';
    var HIGHLIGHT_CSS_DEFAULT = 'atom-one-dark';
    var HIGHLIGHT_JS_URL = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js';

    var DEFAULT_STYLES = {
        opacity: .2,
        overflow: 'hidden',
        margin: 0,
        padding: 0,
        wordBreak: 'break-all',
        hyphens: 'none',
        textAlign: 'center',
        fontFamily: 'Source Code Pro',
        fontSize: '16px',
        lineHeight: 1,
    };

    var qs = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=', 2);
            if (p.length == 1) b[p[0]] = "";
            else b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'));

    var get = function (url, callback) {
        var client = new XMLHttpRequest();
        client.open('GET', url);
        client.onreadystatechange = function() {
            if (client.readyState == 4 && client.status == 200) {
                callback.call(this, client.responseText);
            }
        }
        client.send();
    };

    var loadScript = function (url, callback) {
        var script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        document.documentElement.appendChild(script);
    };

    var loadStyle = function(styleUrl){
        var styleElement = document.createElement('link');
        styleElement.rel = 'stylesheet';
        styleElement.href = styleUrl;
        document.documentElement.appendChild(styleElement);
    };

    var cleanText = function (text) {
        return String(text)
            .replace(/[\n\r]/g, '') // remove new lines
            .replace(/\/\*[\S\s]*?\*\//g, ''); // remove comment blocks
    };

    var appendTextToNode = function (element, data) {
        var dataTextNode = document.createTextNode(data);
        element.appendChild(dataTextNode);
    };

    var hightlightTextInNode = function (codeElement) {
        hljs.highlightBlock(codeElement);
    };

    var addZeroWidthSpacesForWrapping = function (codeElement) {
        // insert zero-width spaces to force wrapping
        function findTextNodes(node, fn) {
            for (node = node.firstChild; node; node = node.nextSibling) {
                if (node.nodeType === Node.TEXT_NODE) {
                    fn(node);
                } else if (node.nodeType === Node.ELEMENT_NODE && node.nodeName !== 'SCRIPT') {
                    findTextNodes(node, fn);
                }
            }
        }

        findTextNodes(codeElement, function (node) {
            node.nodeValue = node.nodeValue.replace(/(.)/g, '$1\u200B');
        });
    };

    var loadHighlightStyle = function (styleName) {
        loadStyle(HIGHLIGHT_CSS_URL_PATTERN.replace('{0}', styleName));
    };

    var loadGoogleFont = function(fontFamily, elementStyle){
        var fontFamilyUrl = String(encodeURIComponent(fontFamily)).replace(/%20/g, "+");
        loadStyle(GOOGLE_FONT_URL_PATTERN.replace('{0}', fontFamilyUrl));
        elementStyle.fontFamily = fontFamily;
    };

    var initFromQueryString = function(codeElement) {
        loadGoogleFont(qs['googleFont'] || GOOGLE_FONT_DEFAULT, codeElement.style);
        loadHighlightStyle(qs['highlightStyle'] || HIGHLIGHT_CSS_DEFAULT);
        var styles = Object.assign({}, DEFAULT_STYLES, qs);

        for (var key in styles)
            codeElement.style[key] = styles[key];
    };

    var applyNodeBgToRoot = function (codeElement) {
        var bgColor = codeElement.style.backgroundColor;
        if (bgColor)
            document.documentElement.style.backgroundColor = bgColor;
    };

    var finalize = function () {
        document.documentElement.classList.add('dom-ready');
    };

    var initScript = function(cdnjsCodeUrl) {
        var title = cdnjsCodeUrl.split('/').pop();
        document.title = title;
        loadScript(HIGHLIGHT_JS_URL, function () {
            var CODE_NODE = document.body;
            initFromQueryString(CODE_NODE);

            // INITIALIZE
            get(cdnjsCodeUrl, function (response) {
                appendTextToNode(CODE_NODE, cleanText(response));
                hightlightTextInNode(CODE_NODE);
                addZeroWidthSpacesForWrapping(CODE_NODE);
                applyNodeBgToRoot(CODE_NODE);
                finalize();
            });
        });
    };

    var CODE_TO_DISPLAY = 'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js';
    if (qs['code']) {
        get('https://api.cdnjs.com/libraries?search=' + encodeURIComponent(qs['code']), function (response) {
            var codeObj = CODE_TO_DISPLAY;
            var resObj = JSON.parse(String(response));
            if (resObj && resObj.results) {
                var results = resObj.results;

                if (Array.isArray(results) && results[0].latest)
                    codeObj = results[0].latest;
            }
            initScript(codeObj);
        });
    } else {
        initScript(CODE_TO_DISPLAY);
    }
</script>
